import singleDatasource from './assets/single-datasource.png';
import chatboxExample from './assets/chatbox.png';

export const title = "When dont't use React useEffect";
export const date = '2022-09-17';
export const author = 'Gialynguyen-Steven';
export const desc =
  'BÃ i viáº¿t tháº£o luáº­n vá» useEffect usecases vÃ  nhá»¯ng sai láº§m khi sá»­ dá»¥ng useEffect sai má»¥c Ä‘Ã­ch';
export const img =
  'https://s3-ap-southeast-1.amazonaws.com/kipalog.com/76stxjgnc9_hook.png';
export const imgWidth = 918;
export const imgHeight = 395;

Trong React 16.8, React team giá»›i thiá»‡u vá» khÃ¡i niá»‡m vá» "React hooks" cÅ©ng nhÆ° cÅ©ng cáº¥p cÃ¡c Hook APIs. Trong Ä‘Ã³ cÃ³ `useEffect`.
Theo giá»›i thiá»‡u trong [official docs](https://reactjs.org/docs/hooks-effect.html), `useEffect` cho phÃ©p thá»±c hiá»‡n cÃ¡c `side effect` bÃªn trong má»™t `Functional Component`

1. Tháº¿ `side effect` lÃ  thá»© gÃ¬?

NÃ³i má»™t cÃ¡ch ngáº¯n gá»n, má»™t `operation`, `function` hay `expr` Ä‘Æ°á»£c cho ráº±ng Ä‘ang thá»±c hiá»‡n má»™t `side effect` khi nÃ³ Ä‘ang lÃ m thay Ä‘á»•i cÃ¡c `variable`, `value`, `state` náº±m bÃªn ngoÃ i `local env` cá»§a chÃ­nh nÃ³.

VÃ­ dá»¥ nhá» nhÆ° sau:

```js
const player = {
  point: 1,
};

const increasePlayerPoint = () => {
  player.point++;
};

increasePlayerPoint();
```

Khi lÃºc nÃ y ta cÃ³ thá»ƒ nÃ³i function `increasePlayerPoint` bÃªn trong nÃ³ Ä‘ang cÃ³ `side effect`.

([Tháº£o kháº£o thÃªm](<https://en.wikipedia.org/wiki/Side_effect_(computer_science)>))

2. Tháº¿ khi nÃ o bÃªn trong `React Functional Component (RFC)` tá»“n táº¡i `side effect`?

NÃ³i má»™t cÃ¡ch ngáº¯n gá»n, `side effect` thÃ´ng thÆ°á»ng chá»‰ nÃªn Ä‘Æ°á»£c sinh ra khi muá»‘n "bÆ°á»›c ra ngoÃ i" RFC vÃ  Ä‘á»ƒ `synchronize` RFC vá»›i cÃ¡c `external` system khÃ¡c.
Khi nÃ y ta sáº½ sá»­ dá»¥ng `useEffect` Ä‘á»ƒ handle.

`External` system á»Ÿ Ä‘Ã¢y cÃ³ thá»ƒ lÃ  báº¥t cá»© thá»© gÃ¬ náº±m bÃªn ngoÃ i RFC nhÆ°: `DOM`, `API Server`, `State Management`, ...

CÃ³ thá»ƒ Ä‘Æ°a ra vÃ­ dá»¥ Ä‘Æ¡n giáº£n nhÆ° sau:

```jsx
const ChatRoom = ({ id }) => {
  // ...

  useEffect(() => {
    const unsubscribe = subscribe(`/chat/room/${id}`);

    return () => {
      unsubscribe();
    };
  }, [id]);

  // ...
};
```

thÃªm má»™t cÃ¡i khÃ¡c ná»¯a =)) :

```jsx
const ChatRoom = ({ id }) => {
  const [filter, setFilter] = useState({});
  // ...

  useEffect(() => {
    fetch(`/search`, {
      method: 'POST',
      body: JSON.stringify(filter),
    });
  }, [filter]);

  // ...
};
```

NhÆ°ng náº¿u `useEffect` Ä‘Æ¡n giáº£n nhÆ° tháº¿ thÃ´i thÃ¬ nÃ³ Ä‘Ã£ khÃ´ng trá»Ÿ thÃ nh Ä‘á» tÃ i tranh cÃ£i cÅ©ng nhÆ° lÃ  "niá»m Ä‘au" khi scale React codebase.
Sau nÃ y lÃ  nhá»¯ng sai láº§m khi sá»­ dá»¥ng `useEffect`, mÃ¬nh sáº½ khÃ´ng Ä‘á» cáº­p Ä‘áº¿n cÃ¡c "sai láº§m cÆ¡ báº£n" nhÆ° vá» `cleanup` hay `dependencies` Ä‘Ã¢u, cÃ³ thá»ƒ `google` thÃªm giÃºp mÃ¬nh Ä‘oáº¡n nÃ y nhan ğŸ˜.

3. Sai láº§m 1: Sá»­ dá»¥ng `useEffect` nhÆ° má»™t `callback` sau khi thá»±c hiá»‡n má»™t `action` hay `event handler`

Sai láº§m Ä‘áº§u tiÃªn lÃ  sá»­ dá»¥ng useEffect nhÆ° má»™t `callback`, cá»¥ thá»ƒ nhÆ° sau:

```
    Event handler ----> new state (setState) ----> useEffect ----> Do something
```

CÃ³ thá»ƒ vÃ­ dá»¥ nhÆ° sau:

```jsx
const changeInputState = value => {
  setInputState(value);
};

useEffect(() => {
  props.onChange(inputState);
}, [inputState, props.onChange]);

return <input onChange={changeInputState} />;
```

Thá»© sai trÃ¡i Ä‘áº§u tiÃªn lÃ  thá»© bÃªn trong `useEffect` kia khÃ´ng pháº£i `side effect` vÃ  Ä‘Æ¡n thuáº§n thá»© mÃ  Ä‘oáº¡n code trÃªn Ä‘ang hÆ°á»›ng tá»›i chá»‰ lÃ  má»™t `action`, má»™t `behavior` cá»§a `event handler` lÃ  khi user change input mÃ  thÃ´i.
Má»™t cÃ¡ch Ä‘Æ¡n giáº£n ta cÃ³ thá»ƒ xá»­ lÃ½ nhÆ° sau:

```
    Event handler ----> new state (setState) + (Do something)
```

```jsx
const changeInputState = value => {
  setInputState(value);
  props.onChange(value);
};

return <input onChange={changeInputState} />;
```

4. Sai láº§m 2: Sync Props to State

Báº¡n cÃ³ thá»ƒ tháº¥y Ä‘oáº¡n code nÃ y á»Ÿ Ä‘Ã¢u Ä‘Ã³ trÆ°á»›c Ä‘Ã¢u:

```jsx

    const UserList = ({ users }) => {
        const [displayUsers, setDisplayUsers] = useState([]);

        useEffect(() => {
            setDisplayUsers(users);
        }, [users]);

        return (
            <div>
                {displayUsers.map((user) => (
                    // ...
                ))}
            </div>
        )
    }
```

Má»i thá»© trong cÃ³ váº» váº«n OK, vÃ  váº«n work. NhÆ°ng Ä‘iá»u nÃ y lÃ m tÄƒng Ä‘á»™ phá»©c táº¡p hÆ¡n cho logic cá»§a báº¡n. VÃ¬ sao?
VÃ¬ giá» báº¡n pháº£i take cake 2 datasource Ä‘Ã³ lÃ  props vÃ  cáº£ state. Tháº¿ nÃªn báº¡n nÃªn nhá»› ráº±ng:

```
    Single source of truth
```

NghÄ©a lÃ  chá»‰ nÃªn Ä‘Æ¡n giáº£n hÃ³a vá» duy nháº¥t vá» 1 datasource thÃ´i Ä‘á»ƒ giáº£m Ä‘i Ä‘á»™ phá»©c táº¡p cá»§a chÆ°Æ¡ng trÃ¬nh.
Quay láº¡i vÃ­ dá»¥ trÃªn, vÃ¬ danh sÃ¡ch `user` Ä‘Æ°á»£c nháº­n tá»« `Props` tháº¿ nÃªn viá»‡c sinh ra má»™t `State` ná»¯a chá»‰ Ä‘á»ƒ sync `1vs1` lÃ  dÆ° thá»«a:

```jsx

    const UserList = ({ users }) => {
        return (
            <div>
                {users.map((user) => (
                    // ...
                ))}
            </div>
        )
    }
```

Ok, nÃ³i thÃ¬ dá»… nhÆ°ng láº­p trÃ¬nh khÃ´ng pháº£i lÃºc nÃ o cÅ©ng Ä‘Æ¡n giáº£n nhÆ° váº­y =))

- Thá»© nháº¥t, giáº£ sá»­ nhÆ° ta transform `user` list trÆ°á»›c khi render thÃ¬ sao? Ok, lÃºc nÃ y Ä‘Æ¡n giáº£n ta chá»‰ cáº§n thá»±c hiá»‡n nÃ³ trong quÃ¡ trÃ¬nh `rendering` thÃ´i:

```jsx
// Transform
const displayUsers = users.map(user => {
  // ...
});

// Calculate
const count = users.length;

return; // ...
```

Hoáº·c sá»­ dá»¥ng vá»›i `useMemo` khi cáº§n thiáº¿t:

```jsx
const displayUsers = useMemo(() =>
  users.map(user => {
    // ...
  })
);
```

<img src={singleDatasource} alt='single-datasource' />

- Thá»© 2, reset state khi props changed. TrÆ°á»›c Ä‘Ã¢y ta cÃ³ thá»ƒ tháº¥y Ä‘oáº¡n code nhÆ° sau:

```jsx
const ChatInput = ({ channelId }) => {
  const [inputValue, setInputValue] = useState('');

  useEffect(() => {
    setInputValue('');
  }, [channelId]);

  // ...
};

// Use
<ChatInput channelId={store.channelId} />;
```

Context á»Ÿ Ä‘Ã¢y ta cÃ³ thá»ƒ hÃ¬nh dung tÆ°Æ¡ng tá»± nhÆ° Facebook Messenger: 

<img src={chatboxExample} alt='single-datasource' />

VÃ­ dá»¥ ta Ä‘ang nháº¯n tin vá»›i `Tuáº¥n` nhÆ°ng khÃ´ng muá»‘n nháº¯n ná»¯a vÃ  chuyá»ƒn qua nháº¯n vá»›i `TÃ¨o`. ThÃ¬ khi ta `ChatInput` Component pháº£i Ä‘Æ°á»£c `reset` state hiá»‡n táº¡i Ä‘i.
Äoáº¡n code trÃªn Ä‘Æ¡n nhiÃªn váº«n hoÃ n thÃ nh Ä‘Ãºng nhiá»‡m vá»¥ cá»§a nÃ³. NhÆ°ng Ä‘iá»u nÃ y lÃ  khÃ´ng tá»‘i Æ°u vÃ¬ khi `props.changeId` thay Ä‘á»•i thÃ¬ input váº«n sáº½ hiá»‡n thá»‹ káº¿t quáº£ cÅ©, sau khi effect thá»±c thi,
component láº¡i pháº£i re-render láº¡i thÃ¬ component má»›i thá»±c hiá»‡n xong viá»‡c `reset`. RÃµ rÃ ng lÃ  khÃ¡ dÆ° thá»«a. Thay vÃ o Ä‘Ã³ ta cÃ³ thá»ƒ "chá»‰ Ä‘iá»ƒm" cho React biáº¿t ráº±ng `ChatInput` bÃ¢y giá» Ä‘Ã£ thuá»™c vá»
má»™t `context` má»›i, thuá»™c vá» `convension` hoÃ n toÃ n khÃ¡c, vÃ  cÃ³ thá»ƒ nÃ³i lÃ  "1 instance" hoÃ n toÃ n má»›i cá»§a `ChatInput` Component. Äá»ƒ lÃ m Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³ ta cáº§n chá»‰ ra cho React biáº¿t "dáº¥u hiá»‡u" Ä‘á»ƒ
nháº­n biáº¿t khi nÃ o ta cáº§n React táº¡o 1 "instance" má»›i nhÆ° váº­y, vÃ  hÆ°á»›ng approach lÃ  sáº½ táº­n dá»¥ng `key`:

```jsx
  <ChatInput key={store.channelId} channelId={store.channelId} />;
```

Báº¥t cá»© khi nÃ o `key`  thay Ä‘á»•i, React sáº½ táº¡o láº¡i DOM vÃ  Ä‘áº·t láº¡i tráº¡ng thÃ¡i cá»§a `Component` vÃ  táº¥t cáº£ `children` cá»§a nÃ³. Do Ä‘Ã³, `inputValue` state sáº½ tá»± Ä‘á»™ng `reset`.

CÃ¡c váº¥n Ä‘á» chÃ­nh yáº¿u trÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c biáº¿n Ä‘á»•i vá»›i nhiá»u hÃ¬nh thá»©c khÃ¡c nhau trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn pháº§n má»m, vÃ  cÃ³ thá»ƒ tham kháº£o thÃªm táº¡i
https://beta.reactjs.org/learn/you-might-not-need-an-effect

NhÆ°ng tÃ³m gá»n láº¡i cÅ©ng sáº½ quy vá» 2 `sai láº§m` chÃ­nh bÃªn trÃªn.

Cuá»‘i cÃ¹ng, Ä‘iá»u quan trá»ng nháº¥t cáº§n `keep in mind` Ä‘Ã³ lÃ :
```
  HÃ£y cá»© say "No" vá»›i useEffect khi váº«n cÃ²n cÃ¡ch tiáº¿p cáº­n khÃ¡c.
```